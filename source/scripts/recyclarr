#!/bin/bash -e

# Appdata folder
APPDATA=/root/.config/recyclarr
# First argument. Expects "version" or "nchan"
ARG1="$1"
# Second argument. Expect recyclarr config file
ARG2="$2"

# Print the version and die
if [[ "$ARG1" == "version" ]]; then
  /usr/local/bin/recyclarr --version
  exit $?
fi

# Make recyclarr sync argument
if [[ -n "$ARG2" ]]; then
  # Filter extensions and path
  configFile=$(basename ${ARG2%.*})
  options="-c $APPDATA/configs/$configFile.yml"
fi

# Publish messages to nchan sub
publish() {
  # Always log to syslog
  logger -t recyclarr "$1"

  # Publish to frontend if the argument is nchan
  if [[ "$ARG1" == "nchan" ]]; then
    curl -H "Content-Type: text/plain" -X POST --data "$1" \
      --unix-socket /var/run/nginx.socket \
      "http://localhost/pub/recyclarr?buffer_length=1"
  fi
}

# Create temporary file to hold output
FIFO=$(mktemp -u)
mkfifo $FIFO

# Run the program async and write output lines in that file
/usr/local/bin/recyclarr sync $options 2>&1 >$FIFO &

# Listen output and publish messages
while read LINE; do publish "$LINE"; done <$FIFO

# Wait program ends and send last message
wait
publish "[DONE]"
rm $FIFO
